# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
на модуль контроля за доступом к данным (далее МКДД, Модуль)


## ЗАДАЧА

Разработать модуль котнроля за доступом к данным, который бы в рамках Doctrine2 ORM обеспечивал разделение данных между пользователями так, чтобы пользователь мог выполнять действия только с разрешенными для него данными.


## ОСНОВНЫЕ ПОНЯТИЯ

### ОПРЕДЕЛЕНИЯ

**Организация**
совокупность бизнес-подразделений, действующих как одно целое, имеющих общую структуру управления. Применительно к автосалонам примером организации можно считать: 
* Группу компаний «Рольф», объединяющую большое количество автосалонов;
* Группу компаний «Сигма», объединяющую большое количество автосалонов.

**Юридическое лицо**
организационно-правовая форма ведения бизнеса. Юрлицо в системе учитывается для корректного выставления счетов и формирования бухгалтерских документов.

**Автосалон**
организационная единица по продаже автомобилей.

**Подразделение**
часть автосалона.

В системе поддерживается следующая иерархия:
```
Организация
    |--Автосалоны
    |    |--Автосалон1
    |    |    |--Подразделение1
    |    |    |--Подразделение2
    |    |--Автосалон2
    |    |--Автосалон3
    |--Юрлица
         |--Юрлицо1
         |--Юрлицо2
```

Одна организация может включать один или несколько автосалонов, и использовать для своей деятельности одно или несколько юридических лиц. Т.е. отношения: 
* Организация к Юрлицу как один-ко-много;
* Организация к Автосалону как один-ко-много;
* Автосалон к Подразделению как один-ко-много;
* Юрлицо к Автосалону как много-ко-много.

В целом есть одназначные иерархии:
* Организация -> Автосалон -> Подразделение;
* Организация -> Юрлицо.
Но отношения Автосалон:Юрлицо, и, как следствие Подразделение:Юрлицо носят характер много-ко-много.


### ПРАВА ПОЛЬЗОВАТЕЛЕЙ

В системе используется разделение понятий:
1. Есть действия, которые может выполнить пользователь;
2. Есть данные, с которыми пользователь может выполнить действия.

Перечень действий, которые может выполнить пользователь определяется ролью.

Перечень данных, над которыми пользователь может выполнить действие определяется присвоенными пользователю значениями параметров:
1. Коды организаций;
2. Коды юридических лиц;
3. Коды автосалонов;
4. Коды подразделений.

Кроме того в системе есть понятие администратор сущности. Например администратор объявлений имеет доступ к объявлениям о продаже авто всех пользователей. Администратор пользователей имеет доступ ко всем профилям пользователей и т.д. Признак администратора задается при конфигурировании МКДД для сущности.


## РАЗВЕРНУТАЯ ЗАДАЧА

Любая операция с данными, выполняемая с помощью Doctrine2 ORM, должна проходить проверку в МКДД:
1. Выборки данных – должны добавляться условия фильтрации, если в запросе уже заданы параметры фильтрации, влияющие на безопасность, то должна быть проверка на соответствие значений разрешенным для пользователя;
2. Добавление и изменение данных – должны проверяться значения полей, используемых для разделения данных, а если значений нет – добавляться значения по умолчанию для пользователя, если у него есть значения по умолчанию.
3.Удаление данных – должна выполняться проверка: имеет ли пользователь права на эту сущность.

Под значением по умолчанию понимается единственное значение параметра для пользователя. Например, если пользователю соответствует только один код подразделения, то этот код можно использовать как значение по умолчанию. Если пользователю соответствует два кода подразделения, то у него нет значения по умолчанию.

Нарушение каких-либо условий в МКДД должно приводить к:
1. Логированию события в лог ошибок;
2. Пребыванию действия с помощью эксепшина системы безопасности.



### ПРИМЕРЫ

#### Первый
Для пользователя Один установлена роль – менеджер. Роль определяет набор доступных пользователю действий, что находится за рамками ТЗ. Так же для пользователя Один  задан один код салона Евросиб Лахта.
В системе реализована сущность Ценники, для которой МКДД настроен на разделение данных по кодам автосалонов.
В этом случае пользователь Один должен иметь возможность выполнять только действия над записями с кодом автосалона Евросиб Лахта. При создании пользователем новых сущностей, они должны иметь код автосалона Евросиб Лахта. 

### Второй
Все как в первом примере, но для пользователя Два задано два кода автосанов: Евросиб Лахта и Евросиб Пулково.
В этом случае пользователь Два должен иметь возможность выполнять действия над записями с любым из этих двух кодов. При создании новых сущностей пользователь должен задать код автосалона принудительно, т.е. МКДД сам не подставляет значение по умолчанию для кода автосалона, но заданный код должен быть в рамках присвоенных пользователю кодов, и МКДД должна это проверить.

### Третий
Все как в первом примере, но для пользователя Три задан код организации Евросиб. Это значит, что пользователь может выполнять действия над записями всех автосалонов, входящих в Организацию Евросиб. Если таких автосалонов 10 штук, значит над записями всех 10 салонов.

### Четвертый
Есть сущность – счета, МКДД для которой настроена на разделение данных по:
* Автосалонам (каждый менеджер видит счета своих Автосалонов, но не видит счета чужих автосалонов в рамках одной Организации);
* Орлицам (каждый бухгалтер видит счета своих Юрлиц, но не видит счета других Юрлиц в рамках одной Организации).

Если для пользователя заданы коды Автосалонов, но не заданы коды Юрлиц, то такой пользователь имеет доступ только к данным своих Автосалонов.

Если для пользователя заданы коды Юрлиц, но не заданы коды Автосалонов, то такой пользователь имеет доступ только к данным своих Юрлиц.

Если для пользователя заданы как коды Автосалонов так и коды Юрлиц, то такой пользователь имеет доступ ко всем счетам своих Автосалонов + ко всем счетам своих Юрлиц (т.е. фильтр по Автосалонам соединен с фильтром по Юрлицам на условии OR, в результате получается максимально-широкаяя выборка).


## ПРОЧЕЕ

Надо продумать использование МКДД в тестах, чтобы при создании фикстур не возникало срабатывание МКДД.
В МКДД должна быть предусмотрена возможность включения/отключения. 
